package com.midproject.tripin.service.impl;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.URL;
import java.net.URLEncoder;

import javax.net.ssl.HttpsURLConnection;

import org.json.JSONArray;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.midproject.tripin.model.PlaceVO;
import com.midproject.tripin.repository.PlaceRepo;
import com.midproject.tripin.service.PlaceOpenAPIService;


@Service("placeOpenAPIService")
public class PlaceOpenAPIServiceImpl implements PlaceOpenAPIService{
	@Autowired
	private PlaceRepo placeRepo;

	public int fetchAndSavePlaces() {
		int savedCount = 0;
		
		try {
			String serviceKey = "It%2FGnlGdSEN8rTI9utdTTht%2FodchebqCirUx8t7QCttJazG%2Br1gS%2FfrN6Ku1kIdVfr3Carf%2BPVow7NpHVG5jpg%3D%3D";
			String urlStr = "https://apis.data.go.kr/B551011/KorService1/areaBasedList2"
					+ "?serviceKey=" + URLEncoder.encode(serviceKey, "UTF-8")
					+ "&numOfRows=10" 		//한페이지당 결과 수 
			        + "&pageNo=1"			//요청할 페이지 번호
			        + "&MobileOS=ETC"		//호출하는 os
			        + "&MobileApp=Tripin"	//호출 앱 이름
			        + "&arrange=A"			//정렬방법 
			        + "&contentTypeId=12"	//콘텐츠유형
			        + "&areaCode=1"			//지역코드 
			        + "&_type=json";		//응답타입
			
			//Java에서 외부 api에 get요청 
			URL url = new URL(urlStr);
			HttpsURLConnection conn = (HttpsURLConnection) url.openConnection();
			conn.setRequestMethod("GET");
			
			//openAPI에서 관광지 정보 가져와서 DB저장 
			
			//api응답 줄 단위로 읽어 문자열sb로 저장
			BufferedReader br = new BufferedReader(new InputStreamReader(conn.getInputStream()));
			StringBuilder sb = new StringBuilder();
			String line;
			while ((line = br.readLine()) != null) sb.append(line);
			br.close();
			
			//JSON파싱
			JSONObject response = new JSONObject(sb.toString());
			
			//
			JSONArray items = response.getJSONObject("response")
			                          .getJSONObject("body")
			                          .getJSONObject("items")
			                          .getJSONArray("item");
			
			for (int i = 0; i < items.length(); i++) {
			    JSONObject obj = items.getJSONObject(i);
			    
			    PlaceVO place = new PlaceVO();
			    place.setDest_id(obj.getString("contentid"));
			    place.setDest_name(obj.getString("title"));
			    place.setDest_type(obj.optString("cat2", ""));
			    place.setFull_address(obj.optString("addr1", ""));
			    place.setContact_num(obj.optString("tel", ""));
			    place.setRepr_img_url(obj.optString("firstimage", ""));
			    place.setOrig_json_data(obj.toString());
			
			//DB중복확인 후 저장
			if(placeRepo.selectPlaceById(place.getDest_id())==null) {
				placeRepo.insertPlace(place);
				savedCount++;
			}
			
			}
			
		} catch (Exception e) {
			e.printStackTrace();
		}
		
		return savedCount;
	}
	
	
	
}
